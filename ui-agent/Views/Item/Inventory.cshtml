@model List<lib.Item>

@{
    ViewData["Title"] = "Inventory";
}

<form id="checkbox-form" method="get">
    <!-- Controls -->
    <div class="cell shrink medium-cell-block-container">
        <div class="grid-x grid-margin-x align-middle">
            <div class="cell shrink">
                <div class="button-group">
                    <span class="input-group-label">Bulk Action</span>
                    <select id="selectPlatform" class="input-group-field">
                        <option value="ebay">eBay</option>
                        <option value="poshmark">Poshmark</option>
                    </select>
                    <input id="import-selected-btn" type="submit" class="button" value="Import Selected" onclick="onBoxCheck()">
                </div>
            </div>
            <div class="cell shrink">
                <div class="input-group">
                    <span class="input-group-label">Platform Filter</span>
                    <select class="input-group-field">
                        <option value="*">All</option>
                        <option value="amazon">Amazon</option>
                        <option value="eBay">eBay</option>
                        <option value="Etsy">Etsy</option>
                        <option value="~/inventoryposhmark">Poshmark</option>
                        <option value="Mercari">Mercari</option>
                        <option value="Emag">Emag</option>
                    </select>
                </div>
            </div>
            <div class="cell shrink">
                <div class="input-group">
                    <span class="input-group-label">Show</span>
                    <select class="input-group-field">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="input-group-label">Rows</span>
                </div>
            </div>
            <div class="cell shrink">
                <div class="primary button-group">
                    <a class="button"><i class="fi-arrow-up" style="font-size: 24px"></i></a>
                    <a class="button"><i class="fi-arrow-down" style="font-size: 24px"></i></a>
                </div>
            </div>
            <div class="cell shrink">
                <div class="input-group">
                    <input class="input-group-field" placeholder="Search" type="text" />
                    <select class="input-group-field">
                        <option value="*">All Fields</option>
                        <option value="Title">Title</option>
                        <option value="SKU">SKU</option>
                        <option value="Description">Description</option>
                    </select>
                    <div class="input-group-button">
                        <button type="button" class="button full-height float-right">
                            <i class="fi-magnifying-glass" style="font-size: 14px;"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="cell full-height medium-auto medium-cell-block-container">
        <!-- Main data section -->
        <table class="scroll">
            <thead>
                <tr>
                    <th> </th>
                    <th>Flag</th>
                    <th>Image</th>
                    <th>Product Name</th>
                    <th>Listings</th>
                    <th>SKU</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Created</th>
                    <th>Has Offer</th>
                    @*<th>Shares</th>
                        <th>Likes</th>
                        <th>Comments</th>*@
                    <th>Follow-up Link</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td><input type="checkbox" id="@item.ID" name="checkbox-ID" value="@item.ID"></td>
                        <td>@item.Status</td>
                        <td><img class="thumb40" src="@item.MainImageURL"></td>
                        <td><a href="../item/edit" target="_blank">@item.Title</a></td>
                        <td>
                            <a href="@item.URL"
                               target="_blank">
                                <img src="../images/@item.Provisioner-thumb.png">
                            </a>
                        </td>
                        <td>N/A</td>
                        <td>$@item.Price</td>
                        <td>@item.Stock</td>
                        <td>@item.Date</td>
                        <td>@item.HasOffer</td>
                        @*<td>@item.Shares</td>
                            <td>@item.Likes</td>
                            <td>@item.Comments</td>*@
                        <td><a href="@item.URL" target="_blank">@item.Provisioner Sale</a></td>
                    </tr>
                }
            </tbody>
        </table>
        <p>@ViewBag.EmptyInventoryMessage</p>
    </div>
</form>

<script>

    function onBoxCheck(valuesJSON)
    {
        // Get HTML form
        const form = document.getElementById('checkbox-form');

        // On form submit (by clicking Import Selected button), insert all checkboxes values into "values" variable.
        form.addEventListener('submit', e => {
            e.preventDefault();
            const values = Array.from(document.querySelectorAll('input[type=checkbox]:checked'))
                .map(item => item.value);

            // Object to be populated by either ebay or poshmark IDs
            var ids = {};

            var xhrAction = "";
            // Add the corresponding key to identify the values based on the platform
            var selectPlatform = document.getElementById("selectPlatform");
            var selectedValue = selectPlatform.options[selectPlatform.selectedIndex].value;

            const xhr = new XMLHttpRequest();

            if (selectedValue == "ebay")
            {
                ids.EbayIDs = values;
                xhrAction = "/item/importtoebay";
            }
            else if (selectedValue == "poshmark")
            {
                ids.PoshmarkIDs = values;
                xhrAction = "/item/importtoposhmark";
            }

            // Convert values array to JSON format
            valuesJSON = JSON.stringify(ids);
            console.log(valuesJSON);

            console.log(xhrAction);
            xhr.open("POST", xhrAction, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(valuesJSON);
        });
    }

</script>
